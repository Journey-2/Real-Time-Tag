<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Location Tracking</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 400px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Firebase JavaScript SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database.js"></script>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let map, marker, circle;
        let updateInterval;
        const centerLocation = [15.460242057381775, 73.83513626465253];
        let circleRadius = 100; // Initial radius

        function initMap() {
            map = L.map('map').setView(centerLocation, 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                fillColor: 'lightblue' // Set the fillColor for the entire map
            }).addTo(map);

            marker = L.marker(centerLocation).addTo(map);
            circle = L.circle(centerLocation, {
                color: 'red',
                fillColor: 'blue',
                fillOpacity: 0.2,
                radius: circleRadius
            }).addTo(map);

            getCurrentLocation();
            updateInterval = setInterval(getCurrentLocation, 5000); // Update location every 5 seconds

            // Reduce circle radius by 1/10 every 3 seconds until it reaches 10
            setInterval(reduceCircleRadius, 3000);

            // Listen for changes in other devices' locations
            updateOtherDevicesLocations();
        }

        function reduceCircleRadius() {
            if (circleRadius > 30) {
                circleRadius -= circleRadius / 10; // Reduce radius by 1/10
                circle.setRadius(circleRadius); // Update circle radius on the map
            } else {
                clearInterval(updateInterval); // Stop reducing radius when it reaches 10
            }
        }

        function getCurrentLocation() {
            console.log("Updating map...");
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const { latitude, longitude } = position.coords;
                        const userLocation = [latitude, longitude];
                        map.setView(userLocation, 20);
                        marker.setLatLng(userLocation);
                        const distance = map.distance(centerLocation, userLocation);
                        if (distance > circleRadius) {
                            alert("You are outside the circle!");
                        }

                        // Update user's location in Firebase
                        database.ref('userLocation').set({ latitude, longitude });
                    },
                    function(error) {
                        console.error("Error getting current location:", error);
                        handleLocationError(error);
                    }
                );
            } else {
                console.error("Geolocation is not supported by this browser.");
            }
        }

        function updateOtherDevicesLocations() {
            const otherDevicesLocationRef = database.ref('otherDevicesLocation');
            otherDevicesLocationRef.on('value', function(snapshot) {
                const locations = snapshot.val();
                if (locations) {
                    Object.keys(locations).forEach(deviceId => {
                        const { latitude, longitude } = locations[deviceId];
                        const deviceLocation = [latitude, longitude];
                        // Check if marker already exists, update; otherwise, create new marker
                        if (!map.hasLayer(deviceId)) {
                            const newMarker = L.marker(deviceLocation).addTo(map);
                            newMarker.bindPopup(`Device ${deviceId}`).openPopup();
                            map.addLayer(newMarker);
                        } else {
                            map.eachLayer(function(layer) {
                                if (layer._latlng && layer._latlng.lat === latitude && layer._latlng.lng === longitude) {
                                    layer.setLatLng(deviceLocation);
                                }
                            });
                        }
                    });
                }
            });
        }

        function handleLocationError(error) {
            let errorMessage = "Error getting current location:";
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += " User denied the request for Geolocation.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += " Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    errorMessage += " The request to get user location timed out.";
                    break;
                case error.UNKNOWN_ERROR:
                    errorMessage += " An unknown error occurred.";
                    break;
            }
            console.error(errorMessage);
            alert(errorMessage);
        }

        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
